<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Query Runner</title>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <style>
        /* Style remains unchanged */
    </style>
</head>
<body>
    <div class="container">
        <h1>KQL Query Runner</h1>
        
        <!-- Authentication Section -->
        <div id="authSection" class="section">
            <button id="signInButton">Sign in with Azure</button>
            <div id="userInfo" class="hidden">
                Signed in as: <span id="userName"></span>
                <button id="signOutButton">Sign Out</button>
            </div>
        </div>

        <!-- Workspace Selection Section -->
        <div id="workspaceSection" class="section hidden">
            <h2>Select Workspace</h2>
            <select id="subscriptionSelector">
                <option value="">Select a subscription...</option>
            </select>
            <select id="workspaceSelector" disabled>
                <option value="">Select a workspace...</option>
            </select>
        </div>
        
        <!-- Query Selection Section -->
        <div id="querySection" class="section hidden">
            <h2>Select Query</h2>
            <select id="querySelector">
                <option value="">Select a query...</option>
            </select>
            
            <div class="query-preview" id="queryPreview">
                Select a query to preview its contents...
            </div>
            <button id="runButton" disabled>Run in Sentinel</button>
        </div>
        
        <div id="loading" class="loading">Loading...</div>
        <div id="error" class="error"></div>
    </div>

    <script>
        const msalConfig = {
            auth: {
                clientId: "2ab668f3-12c0-4405-bd98-2c882fbde905",
                authority: "https://login.microsoftonline.com/common",
                redirectUri: window.location.origin,
            }
        };

        const loginRequest = {
            scopes: ["https://management.azure.com/user_impersonation"]
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const signInButton = document.getElementById('signInButton');
        const runButton = document.getElementById('runButton');
        const querySelector = document.getElementById('querySelector');
        const subscriptionSelector = document.getElementById('subscriptionSelector');
        const workspaceSelector = document.getElementById('workspaceSelector');

        // Function to handle the constructed URL for Azure Log Analytics
        runButton.addEventListener('click', async () => {
            const selectedQueryOption = querySelector.selectedOptions[0];
            if (!selectedQueryOption || !selectedQueryOption.value) {
                alert("Please select a query first.");
                return;
            }

            const queryContent = await fetchQueryContent(selectedQueryOption.value, selectedQueryOption.dataset.downloadUrl);
            if (!queryContent) return;

            const subscriptionId = subscriptionSelector.value;
            const workspaceId = workspaceSelector.value;
            const workspaceName = workspaceSelector.selectedOptions[0].textContent;
            const resourceGroup = workspaceSelector.selectedOptions[0].dataset.resourceGroup;

            // **Fix: Double encode special characters in the KQL query**
            const doubleEncodedQuery = encodeURIComponent(encodeURIComponent(queryContent));

            // **Fix: Construct the resource ID and encode it**
            const workspaceResourceId = `/subscriptions/${subscriptionId}/resourceGroups/${resourceGroup}/providers/Microsoft.OperationalInsights/workspaces/${workspaceName}`;
            const doubleEncodedResourceId = encodeURIComponent(encodeURIComponent(workspaceResourceId));

            // **Fix: Updated Azure Log Analytics URL format**
            const portalUrl = `https://portal.azure.com/#blade/Microsoft_OperationsManagementSuite_Workspace/AnalyticsBlade/initiator/LogsBlade.AnalyticsShareLinkToQuery/isQueryEditorVisible/true/scope/${doubleEncodedResourceId}/query/${doubleEncodedQuery}`;

            // Open URL in a new tab
            window.open(portalUrl, '_blank');
        });

        async function fetchQueryContent(fileName, downloadUrl) {
            const response = await fetch(downloadUrl);
            if (!response.ok) {
                alert("Failed to fetch query content.");
                return null;
            }
            return response.text();
        }
    </script>
</body>
</html>
